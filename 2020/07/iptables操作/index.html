<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>iptablse服务管理 | Outsrkem</title><meta name="generator" content="hexo-theme-ayer"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/dist/main.css"><link rel="stylesheet" href="/css/fonts/remixicon.css"><link rel="stylesheet" href="/css/custom.css"><script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script><script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script><style>.swal2-styled.swal2-confirm{font-size:1.6rem}</style></head></html><body><div id="app"><main class="content on"><section class="outer"><article id="post-iptables操作" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal><div class="article-inner"><header class="article-header"><h1 class="article-title sea-center" style="border-left:0" itemprop="name"> iptablse服务管理</h1></header><div class="article-meta"> <a href="/2020/07/iptables%E6%93%8D%E4%BD%9C/index.html" class="article-date"><time datetime="2020-07-23T13:40:42.000Z" itemprop="datePublished">2020-07-23 21:40:42 +08:00</time></a><div class="article-category"> <a class="article-category-link" href="/categories/%E7%B3%BB%E7%BB%9F/">系统</a></div><div class="word_count"><span class="post-time"><span class="post-meta-item-icon"><i class="ri-quill-pen-line"></i> <span class="post-meta-item-text">字数统计:</span> <span class="post-count">3.1k</span></span></span> <span class="post-time">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="ri-book-open-line"></i> <span class="post-meta-item-text">阅读时长≈</span> <span class="post-count">13 分钟</span></span></span></div></div><div class="tocbot"></div><div class="article-entry" itemprop="articleBody"><p>iptablse服务管理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service iptables start|stop|restart|status</span><br><span class="line">service iptables save   //定义的所有内容，在重启时都会失效。调用save命令可以把规则保存到文件/etc/sysconfig/iptables中。</span><br><span class="line">iptables-save           //保存规则</span><br><span class="line">iptables-restore        //加载规则。开机的时候，会自动加载/etc/sysconfig/iptables</span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables2     //加载自定义的规则文件</span><br><span class="line">//iptables服务配置文件：   /etc/sysconfig/iptables-config</span><br><span class="line">//iptables规则文件：       /etc/sysconfig/iptables</span><br><span class="line">echo &quot;1&quot;&gt;/proc/sys/net/ipv4/ip_forward   //打开iptables转发：</span><br></pre></td></tr></table></figure><p>COMMAND 命令选项</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-A|--append  CHAIN                                 //链尾添加新规则</span><br><span class="line">-D|--delete  CHAIN [RULENUM]                       //删除链中规则，按需序号或内容确定要删除的规则</span><br><span class="line">-I|--insert  CHAIN [RULENUM]                       //在链中插入一条新的规则，默认插在开头</span><br><span class="line">-R|--replace CHAIN  RULENUM                        //替换、修改一条规则，按序号或内容确定</span><br><span class="line">-L|--list   [CHAIN [RULENUM]]                      //列出指定链或所有链中指定规则或所有规则</span><br><span class="line">-S|--list-urles [CHAIN [RULENUM]]                  //显示链中规则</span><br><span class="line">-F|--flush [CHAIN]                                 //清空指定链或所有链中规则</span><br><span class="line">-Z|--zero [CHAIN [RULENUM]]                        //重置指定链或所有链的计数器(匹配的数据包数和流量字节数)</span><br><span class="line">-N|--new-chain CHAIN                               //新建自定义规则链</span><br><span class="line">-X|--delete-cahin [CHAIN]                          //删除指定表中用户自定义的规则链</span><br><span class="line">-E|--rename-chain OLDCHAIN NEWCHAIN                //重命名链，移动任何引用</span><br><span class="line">-P|-policy CHAIN TARGET                            //设置链的默认策略，数据包未匹配任意一条规则就按此策略处理</span><br></pre></td></tr></table></figure><p>CRETIRIA 条件匹配</p><p>分为基本匹配和扩展匹配，扩展匹配又分为隐式匹配和显示匹配</p><p>基本匹配</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-p|--proto  PROTO                      //按协议匹配，如tcp、udp、icmp，all表示所有协议。 （/etc/protocols中的协议名）</span><br><span class="line">-s|--source ADDRESS[/mask]...          //按数据包的源地址匹配，可使用IP地址、网络地址、主机名、域名</span><br><span class="line">-d|--destination ADDRESS[/mask]...     //按目标地址匹配，可使用IP地址、网络地址、主机名、域名</span><br><span class="line">-i|--in-interface INPUTNAME[ +]        //按入站接口(网卡)名匹配，+用于通配。如 eth0, eth+ 。一般用在INPUT和PREROUTING链</span><br><span class="line">-o|--out-interface OUTPUTNAME[+]       //按出站接口(网卡)名匹配，+用于通配。如 eth0, eth+ 。一般用在OUTPUT和POSTROUTING链</span><br><span class="line">可使用 ! 可以否定一个子句，如-p !tcp</span><br></pre></td></tr></table></figure><p>扩展匹配</p><p>-m|–match MATCHTYPE EXTENSIONMATCH… //扩展匹配，可能加载extension</p><p>如: -p tcp -m tcp --dport 80</p><p>隐式扩展匹配(对-p PROTO的扩展，或者说是-p PROTO的附加匹配条件)</p><p>-m PROTO 可以省略，所以叫隐式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-m tcp   //-p tcp的扩展</span><br><span class="line">　　　　--sport  [!]N[:M]                      //源端口, 服务名、端口、端口范围。</span><br><span class="line">　　　　--dport  [!]N[:M]                      //目标端口，服务名、端口、端口范围</span><br><span class="line">　　　　--tcp-flags CHECKFLAGS FLAGSOFTRUE  //TCP标志位:SYN(同步),ACK(应答),RST(重置),FIN(结束),URG(紧急),PSH(强迫推送)。多个标志位逗号分隔。</span><br><span class="line">　　　　　　　　　　　　　　　　　　　　　　　　　//CHECKFLAGS为要检查的标志位，FLAGSOFTRUE为必须为1的标志位（其余的应该为0）</span><br><span class="line">　　　　--syn                               //第一次握手。 等效于 --tcpflags syn,ack,fin,rst syn   四个标志中只有syn为1</span><br><span class="line">-m udp   //-p udp的扩展</span><br><span class="line">　　　　--sport N[-M] </span><br><span class="line">　　　　--dport N[-M]</span><br><span class="line">-m icmp  //隐含条件为-p icmp</span><br><span class="line">　　　　--icmp-type  N             //8:echo-request  0:echo-reply</span><br></pre></td></tr></table></figure><p>显示扩展匹配</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">-m state</span><br><span class="line">　　　　--state    //连接状态检测，NEW,ESTABLISHED,RELATED,INVALID</span><br><span class="line">-m multiport </span><br><span class="line">　　　　--source-ports   PORT[,PORT]...|N:M            //多个源端口，多个端口用逗号分隔，</span><br><span class="line">　　　　--destination-ports PORT[,PORT]...|N:M         //多个目的端口</span><br><span class="line">　　　　--ports     　　　　　　　　　　　　　　　　　　　　 //多个端口，每个包的源端口和目的端口相同才会匹配</span><br><span class="line">-m limit</span><br><span class="line">　　　　--limit   N/UNIT    //速率，如3/minute, 1/s, n/second , n/day</span><br><span class="line">　　　　--limit-burst N     //峰值速率，如100，表示最大不能超过100个数据包</span><br><span class="line">-m connlimit</span><br><span class="line">　　　　--connlimit-above N  //多于n个，前面加!取反</span><br><span class="line">-m iprange</span><br><span class="line">　　　　--src-range IP-IP</span><br><span class="line">　　　　--dst-range IP-IP</span><br><span class="line">-m mac                    </span><br><span class="line">　　　　--mac-source         //mac地址限制，不能用在OUTPUT和POSTROUTING规则链上，因为封包要送到网卡后，才能由网卡驱动程序透过ARP 通讯协议查出目的地的MAC 地址</span><br><span class="line">-m string</span><br><span class="line">　　　　--algo [bm|kmp]      //匹配算法</span><br><span class="line">　　　　--string &quot;PATTERN&quot;   //匹配字符模式</span><br><span class="line">-m recent</span><br><span class="line">　　　　--name               //设定列表名称，默认为DEFAULT</span><br><span class="line">　　　　--rsource            //源地址</span><br><span class="line">　　　　--rdest              //目的地址</span><br><span class="line">　　　　--set                //添加源地址的包到列表中</span><br><span class="line">　　　　--update             //每次建立连接都更新列表</span><br><span class="line">　　　　--rcheck             //检查地址是否在列表</span><br><span class="line">　　　　--seconds            //指定时间。必须与--rcheck或--update配合使用</span><br><span class="line">　　　　--hitcount           //命中次数。必须和--rcheck或--update配合使用</span><br><span class="line">　　　　--remove             //在列表中删除地址</span><br><span class="line">-m time</span><br><span class="line">　　　　--timestart h:mm</span><br><span class="line">　　　　--timestop  hh:mm</span><br><span class="line">　　　　--days DAYS          //Mon,Tue,Wed,Thu,Fri,Sat,Sun; 逗号分隔</span><br><span class="line">-m mark</span><br><span class="line">　　　　--mark N            //是否包含标记号N</span><br><span class="line">-m owner </span><br><span class="line">　　　　--uid-owner 500   //用来匹配来自本机的封包，是否为某特定使用者所产生的,可以避免服务器使用root或其它身分将敏感数据传送出</span><br><span class="line">　　　　--gid-owner O     //用来匹配来自本机的封包，是否为某特定使用者群组所产生的</span><br><span class="line">　　　　--pid-owner 78    //用来匹配来自本机的封包，是否为某特定进程所产生的</span><br><span class="line">　　　　--sid-owner 100   //用来匹配来自本机的封包，是否为某特定连接（Session ID）的响应封包</span><br></pre></td></tr></table></figure><p>ACTION 目标策略(TARGET)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-j|--jump TARGET                //跳转到目标规则，可能加载target extension</span><br><span class="line">-g|--goto  CHAIN                //跳转到指定链，不再返回</span><br><span class="line">ACCEPT             规则验证通过，不再检查当前链的后续规则，直接跳到下一个规则链。</span><br><span class="line">DROP                直接丢弃数据包，不给任何回应。中断过滤。</span><br><span class="line">REJECT             拒绝数据包通过，会返回响应信息。中断过滤。</span><br><span class="line">--reject-with  tcp-reset|port-unreachable|echo-reply</span><br><span class="line">LOG                  在/var/log/messages文件中记录日志，然后将数据包传递给下一条规则。详细位置可查看/etc/syslog.conf配置文件</span><br><span class="line">--log-prefix &quot;INPUT packets&quot;</span><br><span class="line">ULOG                更广范围的日志记录信息</span><br><span class="line">QUEUE              防火墙将数据包移交到用户空间，通过一个内核模块把包交给本地用户程序。中断过滤。</span><br><span class="line">RETURN            防火墙停止执行当前链中的后续规则，并返回到调用链。主要用在自定义链中。</span><br><span class="line">custom_chain    转向自定义规则链</span><br><span class="line">DNAT                目标地址转换，改变数据包的目标地址。外网访问内网资源，主要用在PREROUTING。完成后跳到下一个规则链</span><br><span class="line">--to-destination ADDRESS[-ADDRESS][:PORT[-PORT]]</span><br><span class="line">SNAT                源地址转换，改变数据包的源地址。内网访问外网资源。主机的IP地址必须是静态的，主要用在POSTROUTING。完成后跳到下一个规则链。</span><br><span class="line">--to-source ADDRESS[-ADDRESS][:PORT[-PORT]]</span><br><span class="line">MASQUERADE   源地址伪装，用于主机IP是ISP动态分配的情况，会从网卡读取主机IP。直接跳到下一个规则链。</span><br><span class="line">--to-ports 1024-31000</span><br><span class="line">REDIRECT        数据包重定向，主要是端口重定向，把包分流。处理完成后继续匹配其他规则。能会用这个功能来迫使站点上的所有Web流量都通过一个Web高速缓存，比如Squid。</span><br><span class="line">--to-ports 8080</span><br><span class="line">MARK                 打防火墙标记。继续匹配规则。</span><br><span class="line">--set-mark 2</span><br><span class="line">MIRROR           发送包之前交换IP源和目的地址，将数据包返回。中断过滤。</span><br></pre></td></tr></table></figure><p>辅助选项</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-t|--table TABLE     //指定操作的表，默认的表为filter</span><br><span class="line">-n|--numeric         //用数字形式显示地址和端口，显示主机IP地址而不是主机名</span><br><span class="line">-x|--exact           //计数器显示精确值，不做单位换算</span><br><span class="line">-v|--verbose  (x3)   //查看规则列表时，显示更详细的信息</span><br><span class="line">-line-numbers        //查看规则表时，显示在链中的序号</span><br><span class="line">-V|--version </span><br><span class="line">-h|--help   </span><br><span class="line">[option]  --help     //查看特定选项的帮助，如iptables -p icmp --help</span><br><span class="line">--fragment -f               //match second or further fragments only</span><br><span class="line">--modprobe=&lt;command&gt;        //try to insert modules using this command</span><br><span class="line">--set-counters PKTS BYTES   //set the counter during insert/append</span><br></pre></td></tr></table></figure><p>state TCP链接状态</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NEW                 第一次握手，要起始一个连接（重设连接或将连接重导向） </span><br><span class="line">ESTABLISHED   数据包属于某个已经建立的连接。第二次和第三次握手   (ack=1)</span><br><span class="line">INVALID           数据包的连接编号（Session ID）无法辨识或编号不正确。如SYN=1 ACK=1 RST=1   </span><br><span class="line">RELATED          表示该封包是属于某个已经建立的连接，所建立的新连接。如有些服务使用两个相关的端口，如FTP，21和20端口一去一回，FTP数据传输(上传/下载)还会使用特殊的端口</span><br><span class="line">只允许NEW和ESTABLISHED进，只允许ESTABLISHED出可以阻止反弹式木马。</span><br></pre></td></tr></table></figure><p>使用示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">iptables -F           //删除iptables现有规则</span><br><span class="line">iptables -L [-v[vv] -n]   //查看iptables规则</span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT       //在INPUT链尾添加一条规则</span><br><span class="line">iptables -I INPUT 2 -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT     //在INPUT链中插入为第2条规则</span><br><span class="line">iptables -D  INPUT 2      //删除INPUT链中第2条规则</span><br><span class="line">iptables -R INPUT 3 -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT    //替换修改第三条规则</span><br><span class="line">iptables -P INPUT DROP    //设置INPUT链的默认策略为DROP</span><br><span class="line">//允许远程主机进行SSH连接</span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT </span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT </span><br><span class="line">//允许本地主机进行SSH连接</span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT </span><br><span class="line">iptables -A INTPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT </span><br><span class="line">//允许HTTP请求</span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT </span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT </span><br><span class="line">//限制ping 192.168.146.3主机的数据包数，平均2/s个，最多不能超过3个</span><br><span class="line">iptables -A INPUT -i eth0 -d 192.168.146.3 -p icmp --icmp-type 8 -m limit --limit 2/second --limit-burst 3 -j ACCEPT </span><br><span class="line">//限制SSH连接速率（默认策略是DROP）</span><br><span class="line">iptables -I INPUT 1 -p tcp --dport 22 -d 192.168.146.3 -m state --state ESTABLISHED -j ACCEPT  </span><br><span class="line">iptables -I INPUT 2 -p tcp --dport 22 -d 192.168.146.3 -m limit --limit 2/minute --limit-burst 2 -m state --state NEW -j ACCEPT </span><br><span class="line"> </span><br><span class="line">//防止syn攻击（限制syn的请求速度）</span><br><span class="line">iptables -N syn-flood </span><br><span class="line">iptables -A INPUT -p tcp --syn -j syn-flood </span><br><span class="line">iptables -A syn-flood -m limit --limit 1/s --limit-burst 4 -j RETURN </span><br><span class="line">iptables -A syn-flood -j DROP </span><br><span class="line">//防止syn攻击（限制单个ip的最大syn连接数）</span><br><span class="line">iptables –A INPUT –i eth0 –p tcp --syn -m connlimit --connlimit-above 15 -j DROP </span><br><span class="line"> </span><br><span class="line">iptables -I INPUT -p tcp -dport 22 -m connlimit --connlimit-above 3 -j DROP   //利用recent模块抵御DOS攻击</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH   //单个IP最多连接3个会话</span><br><span class="line">Iptables -I INPUT -p tcp --dport 22 -m state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP  //只要是新的连接请求，就把它加入到SSH列表中。5分钟内你的尝试次数达到3次，就拒绝提供SSH列表中的这个IP服务。被限制5分钟后即可恢复访问。</span><br><span class="line"> </span><br><span class="line">iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j DROP    //防止单个IP访问量过大</span><br><span class="line">iptables –A OUTPUT –m state --state NEW –j DROP  //阻止反弹木马</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/m -j ACCEPT   //防止ping攻击</span><br><span class="line"> </span><br><span class="line">//只允许自己ping别人，不允许别人ping自己</span><br><span class="line">iptables -A OUTPUT -p icmp --icmp-type 8 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 0 -j ACCEPT</span><br><span class="line">//对于127.0.0.1比较特殊，我们需要明确定义它</span><br><span class="line">iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT</span><br><span class="line"> </span><br><span class="line">//SNAT 基于原地址转换。许多内网用户通过一个外网 口上网的情况。将我们内网的地址转换为一个外网的IP，共用外网IP访问外网资源。</span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.100.1</span><br><span class="line">//当外网地址不是固定的时候。将外网地址换成 MASQUERADE(动态伪装):它可以实现自动读取外网网卡获取的IP地址。</span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j MASQUERADE</span><br><span class="line">//DNAT 目标地址转换。目标地址转换要做在到达网卡之前进行转换,所以要做在PREROUTING这个位置上</span><br><span class="line">iptables -t nat -A PREROUTING -d 192.168.10.18 -p tcp --dport 80 -j DNAT --to-destination 172.16.100.2</span><br></pre></td></tr></table></figure><h3 id="linux-开启独立iptables日志">linux 开启独立iptables日志</h3><ul><li>在rsyslog.conf 添加配置，添加不同的日志级别（默认warn(=4））</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rsyslog.conf</span><br><span class="line">kern.warning     /var/log/iptables.log</span><br><span class="line">kern.debug       /var/log/iptables.log</span><br><span class="line">kern.info        /var/log/iptables.log</span><br><span class="line">不过推荐全部日志都记录：  kern.*     /var/log/iptables.log</span><br></pre></td></tr></table></figure><ul><li>重启日志配置：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/rsyslogd restart</span><br></pre></td></tr></table></figure><ul><li>让日志滚动，这一步是可选的</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/logrotate.d/syslog</span><br><span class="line">加入/var/log/iptables</span><br></pre></td></tr></table></figure><ul><li>在iptables添加日志选项</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">记录所有的记录了，只要通过了防火墙都会记录到日志里</span><br><span class="line">iptables -A INPUT  -j LOG --log-prefix &quot;iptables&quot;</span><br><span class="line">只记录tcp日志</span><br><span class="line">iptables -A INPUT  -p tcp -j LOG --log-prefix &quot;iptables icmp warn&quot;</span><br></pre></td></tr></table></figure><ul><li>然后保存并重启防火墙配置</li></ul><div id="reword-out"><div id="reward-btn"> 打赏</div></div></div><div class="declare"><ul class="post-copyright"><li><i class="ri-copyright-line"></i> <strong>版权声明：</strong> 本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！</li></ul></div><footer class="article-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li></ul></footer></div><nav class="article-nav"> <a href="/2020/08/DockerFile%E5%8F%8A%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/index.html" class="article-nav-link"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> DockerFile及常用操作</div></a> <a href="/2020/07/Linux-%E9%85%8D%E7%BD%AE-Git-%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6/index.html" class="article-nav-link"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">Linux 配置 Git 命令提示符</div></a></nav><script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script><div id="twikoo" class="twikoo"></div><script>twikoo.init({envId:""})</script></article></section><footer class="footer"><div class="outer"><ul><li> Copyrights &copy; 2018-2024<i class="ri-heart-fill heart_icon"></i> Outsrkem</li></ul><ul><li></li></ul><ul><li><span><span><i class="ri-user-3-fill"></i> 访问人数:<span id="busuanzi_value_site_uv"></span></span> <span class="division">|</span><span><i class="ri-eye-fill"></i> 浏览次数:<span id="busuanzi_value_page_pv"></span></span></span></li></ul><ul></ul><ul></ul><ul><li><script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914"></script></li></ul></div></footer></main><div class="float_btns"><div class="totop" id="totop"><i class="ri-arrow-up-line"></i></div><div class="todark" id="todark"><i class="ri-moon-line"></i></div></div><aside class="sidebar on"> <button class="navbar-toggle"></button><nav class="navbar"><div class="logo"> <a href="/"><img src="/images/ayer-side.svg" alt="Outsrkem"></a></div><ul class="nav nav-main"><li class="nav-item"> <a class="nav-item-link" href="/index.html">主页</a></li><li class="nav-item"> <a class="nav-item-link" href="/archives/index.html">归档</a></li><li class="nav-item"> <a class="nav-item-link" href="/categories/index.html">分类</a></li><li class="nav-item"> <a class="nav-item-link" href="/tags/index.html">标签</a></li><li class="nav-item"> <a class="nav-item-link" href="/friends/index.html">友链</a></li><li class="nav-item"> <a class="nav-item-link" href="/about/index.html">关于</a></li></ul></nav><nav class="navbar navbar-bottom"><ul class="nav"><li class="nav-item"><a class="nav-item-link nav-item-search" title="搜索"><i class="ri-search-line"></i></a></li></ul></nav><div class="search-form-wrap"><div class="local-search local-search-plugin"> <input type="search" id="local-search-input" class="local-search-input" placeholder="Search..."><div id="local-search-result" class="local-search-result"></div></div></div></aside><div id="mask"></div> <div id="reward"><span class="close"><i class="ri-close-line"></i></span><p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p><div class="reward-box"><div class="reward-item"> <img class="reward-img" src="/images/alipay.jpg"> <span class="reward-type">支付宝</span></div><div class="reward-item"> <img class="reward-img" src="/images/wechat.jpg"> <span class="reward-type">微信</span></div></div></div><script src="/js/jquery-3.6.0.min.js"></script><script src="/js/lazyload.min.js"></script><script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"><script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script><script src="/dist/main.js"></script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css"><script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script><script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script><script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script><script src="/js/busuanzi-2.3.pure.min.js"></script><link rel="stylesheet" href="/css/clipboard.css"><script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script><script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script></div></body>